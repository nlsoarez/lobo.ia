name: 游냨 Lobo IA Trading Bot

on:
  schedule:
    # Executa a cada 30 minutos durante hor치rio de mercado B3 (10h-18h Bras칤lia)
    # GitHub Actions usa UTC, ent칚o 13h-21h UTC = 10h-18h BRT
    - cron: '0,30 13-21 * * 1-5'
  
  workflow_dispatch:  # Permite execu칞칚o manual
    inputs:
      mode:
        description: 'Modo de execu칞칚o'
        required: true
        default: 'analysis'
        type: choice
        options:
          - analysis    # An치lise 칰nica
          - backtest    # Backtesting
          - report      # Gerar relat칩rio

jobs:
  trade:
    runs-on: ubuntu-latest
    
    steps:
      - name: 游닌 Checkout c칩digo
        uses: actions/checkout@v4
      
      - name: 游냀 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 游닍 Instalar depend칡ncias
        run: |
          pip install -r requirements.txt
      
      - name: 游늵 Baixar banco de dados anterior
        uses: actions/download-artifact@v3
        with:
          name: trades-database
          path: .
        continue-on-error: true  # Primeira execu칞칚o n칚o ter치 artifact
      
      - name: 游꿢 Executar an치lise de trading
        if: github.event.inputs.mode != 'backtest' && github.event.inputs.mode != 'report'
        run: |
          python3 main.py
        env:
          PYTHONUNBUFFERED: 1
      
      - name: 游늳 Executar backtesting
        if: github.event.inputs.mode == 'backtest'
        run: |
          python3 backtesting.py
      
      - name: 游늶 Gerar relat칩rio de performance
        if: always()  # Sempre executa
        run: |
          python3 generate_report.py
      
      - name: 游 Salvar banco de dados
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trades-database
          path: trades.db
          retention-days: 30
      
      - name: 游늵 Salvar relat칩rios
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: trading-reports-${{ github.run_number }}
          path: |
            reports/*.html
            reports/*.csv
            logs/*.log
          retention-days: 7
      
      - name: 游닎 Notifica칞칚o por Issue (Dashboard Alternativo)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // L칡 o relat칩rio gerado
            let report = 'Sem dados dispon칤veis';
            try {
              report = fs.readFileSync('reports/summary.txt', 'utf8');
            } catch (e) {
              console.log('Relat칩rio n칚o encontrado');
            }
            
            // Cria ou atualiza issue com o relat칩rio
            const title = `游늵 Lobo IA - Relat칩rio ${new Date().toLocaleDateString('pt-BR')}`;
            
            // Busca issue existente de hoje
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'trading-report',
              state: 'open'
            });
            
            const todayIssue = issues.data.find(i => i.title.includes(new Date().toLocaleDateString('pt-BR')));
            
            if (todayIssue) {
              // Atualiza issue existente
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `## 游댃 Atualiza칞칚o ${new Date().toLocaleTimeString('pt-BR')}\n\n${report}`
              });
            } else {
              // Cria nova issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: report,
                labels: ['trading-report', 'automated']
              });
            }

  # Job separado para Dashboard Web
  dashboard:
    runs-on: ubuntu-latest
    needs: trade
    if: always()
    
    steps:
      - name: 游닌 Checkout
        uses: actions/checkout@v4
      
      - name: 游냀 Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: 游닍 Instalar depend칡ncias
        run: |
          pip install pandas plotly streamlit
      
      - name: 游늵 Baixar dados
        uses: actions/download-artifact@v3
        with:
          name: trades-database
          path: .
      
      - name: 游꿛 Gerar Dashboard HTML est치tico
        run: |
          python3 generate_static_dashboard.py
      
      - name: 游닋 Deploy para GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard_output
          destination_dir: dashboard
